<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Expense Form View Extension -->
    <record id="view_hr_expense_form_ocr" model="ir.ui.view">
        <field name="name">hr.expense.form.ocr</field>
        <field name="model">hr.expense</field>
        <field name="inherit_id" ref="hr_expense.hr_expense_view_form"/>
        <field name="arch" type="xml">

            <!-- Add OCR status in header -->
            <xpath expr="//header" position="inside">
                <button name="action_process_ocr"
                        string="Process OCR"
                        type="object"
                        class="btn-primary"
                        invisible="ocr_status in ['processing', 'completed']"/>

                <button name="action_compare_documents"
                        string="Compare Documents"
                        type="object"
                        class="btn-secondary"
                        invisible="not original_ocr_payload or not attachment_ids"/>

                <button name="action_view_audit_logs"
                        string="Audit Logs"
                        type="object"
                        class="btn-info"
                        invisible="ocr_audit_count == 0"/>

                <field name="ocr_status" widget="statusbar"
                       statusbar_visible="pending,processing,completed"/>
            </xpath>

            <!-- Add OCR tab -->
            <xpath expr="//notebook" position="inside">
                <page string="OCR &amp; Visual Diff" name="ocr_audit">
                    <group name="ocr_info">
                        <group string="OCR Extraction">
                            <field name="ocr_confidence" widget="progressbar"/>
                            <field name="document_version" readonly="1"/>
                            <field name="ocr_audit_count" readonly="1"/>
                        </group>
                        <group string="Visual Diff">
                            <field name="ocr_diff_score" widget="progressbar"/>
                            <field name="has_visual_changes" readonly="1"/>
                        </group>
                    </group>

                    <group name="anomaly_detection" string="Anomaly Detection"
                           invisible="not anomaly_detected">
                        <field name="anomaly_detected" readonly="1"/>
                        <field name="requires_manager_approval" readonly="1"/>
                        <field name="anomaly_reason" readonly="1" colspan="2"/>
                    </group>

                    <group name="ocr_data" string="OCR Data">
                        <field name="ocr_payload" widget="ace"
                               options="{'mode': 'json'}"
                               readonly="1"
                               colspan="2"/>
                    </group>

                    <group name="diff_data" string="Diff Data"
                           invisible="not ocr_diff_json">
                        <field name="ocr_diff_json" widget="ace"
                               options="{'mode': 'json'}"
                               readonly="1"
                               colspan="2"/>
                    </group>

                    <!-- OCR Diff Widget (Custom JavaScript) -->
                    <div class="ocr_diff_widget"
                         invisible="not ocr_diff_json">
                        <widget name="ocr_diff_viewer"/>
                    </div>
                </page>
            </xpath>

            <!-- Add warning banner for anomalies -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-warning" role="alert"
                     invisible="not anomaly_detected">
                    <strong>⚠️ Anomaly Detected</strong>
                    <p><field name="anomaly_reason" readonly="1"/></p>
                </div>
            </xpath>

        </field>
    </record>

    <!-- Expense Tree View Extension -->
    <record id="view_hr_expense_tree_ocr" model="ir.ui.view">
        <field name="name">hr.expense.tree.ocr</field>
        <field name="model">hr.expense</field>
        <field name="inherit_id" ref="hr_expense.view_expenses_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='total_amount']" position="after">
                <field name="ocr_status" optional="show"/>
                <field name="ocr_confidence" optional="hide" widget="progressbar"/>
                <field name="anomaly_detected" optional="show" widget="boolean_toggle"/>
            </xpath>
        </field>
    </record>

</odoo>
