name: analyst
role: data_analyst
description: Metrics + analytics + NL→SQL + dashboards

capabilities:
  - nl_to_sql
  - metric_extraction
  - chart_generation
  - anomaly_detection
  - cost_analysis

tools:
  - mcp/psql
  - mcp/supabase
  - mcp/odoo-rpc
  - chartjs
  - pandas

metrics:
  deployment:
    - name: deployment_frequency
      query: |
        SELECT
          DATE_TRUNC('day', created_at) as date,
          COUNT(*) as deploys
        FROM deployments
        WHERE environment = 'production'
        GROUP BY date
        ORDER BY date DESC
        LIMIT 30

    - name: mean_time_to_deploy
      query: |
        SELECT
          AVG(EXTRACT(EPOCH FROM (deployed_at - pr_opened_at))) / 60 as minutes
        FROM deployments
        WHERE deployed_at IS NOT NULL

    - name: change_failure_rate
      query: |
        SELECT
          COUNT(*) FILTER (WHERE rolled_back = true)::FLOAT /
          NULLIF(COUNT(*), 0) * 100 as failure_rate
        FROM deployments
        WHERE environment = 'production'

  business:
    - name: ocr_processing_stats
      query: |
        SELECT
          COUNT(*) as total_processed,
          AVG(confidence) as avg_confidence,
          COUNT(*) FILTER (WHERE auto_approved = true) as auto_approved,
          AVG(processing_time_ms) as avg_time_ms
        FROM ocr_results
        WHERE created_at > NOW() - INTERVAL '24 hours'

  costs:
    - name: infrastructure_costs
      sources:
        - digitalocean_api
        - openai_api_usage
        - supabase_billing

output_contract:
  metrics:
    type: object
    description: Metric name → value/chart data
    additionalProperties: true

  insights:
    type: array
    items:
      metric: string
      trend: enum  # up, down, stable
      change_percent: float
      anomaly_detected: boolean
      recommendation: string

  charts:
    type: array
    items:
      type: enum  # line, bar, pie, gauge
      title: string
      data: object
      config: object

  cost_breakdown:
    type: object
    properties:
      total_monthly: float
      by_service:
        digitalocean: float
        supabase: float
        openai: float
        github: float
